// first-run.js
var db     = require('circle-blvd/dataAccess');
var errors = require('circle-blvd/errors');
var guard  = errors.guard;

module.exports = function (req, res, next) {
    // Is this our first run? 
    //
    // TODO: It would be nice to not have to call
    // the database for every request, but it's fine
    // for now.
    //
    // The main thing is that app.isInitializing 
    // should be correct all the time.
    var usersExist = function (callback) {
        db.users.count(guard(callback, function (count) {
            callback(null, count > 0);
        }));
    };

    usersExist(errors.guard(res, function (exist) {
        if (!exist) {
            req.app.isInitializing = true;
        }
        else {
            req.app.isInitializing = false;
        }
        next();
    }));
};