// couch/groups.js
//
var guard = require('circle-blvd/errors').guard;

module.exports = function (couch) {
	var database = couch.db;

	var addGroup = function(group, callback) {
		group.type = "group";
		console.log("Adding ...");
		console.log(group);
		database.insert(group, callback);
	};

	var findGroupById = function (groupId, callback) {
		var key = groupId;
		couch.findOneByKey("groups/byId", key, callback);
	};

	var removeGroup = function (group, callback) {
		console.log("Removing ...");
		console.log(group);

		findGroupById(group.id, guard(callback, function (groupToRemove) {
			if (groupToRemove.isPermanent) {
				return callback({
					message: "Cannot remove group. It is marked as permanent."
				});
			}

			database.destroy(groupToRemove._id, groupToRemove._rev, 
				guard(callback, function (body) {
				return callback();
			}));
		}));
	};

	var findGroupsByCircleId = function (circleId, callback) {
		var options = {
			key: circleId
		};
		couch.view("groups/byCircleId", options, callback);
	};

	var findGroupsByUser = function (user, callback) {
		var groupIds = [];

		for (var membershipKey in user.memberships) {
			var membership = user.memberships[membershipKey];
			groupIds.push(membership.group);
		}

		couch.fetch(groupIds, callback);
	};

	return {
		add: addGroup,
		remove: removeGroup,
		findById: findGroupById,
		findByProjectId: findGroupsByCircleId,
		findByUser: findGroupsByUser
	};
};