// couch/circles.js
//
var guard = require('@holmwell/errors').guard;

module.exports = function (couch) {
	var database = couch.db;

	var addCircle = function (circle, callback) {
		circle.type = "circle";
		database.insert(circle, callback);
	};

	var getAllCircles = function (callback) {
		couch.view("circles/byName", callback);
	};

	var getCircle = function (circleId, callback) {
		couch.docs.get(circleId, guard(callback, function (circle) {
			if (circle.type !== "circle") {
				var error = new Error("Document is not a circle");
				error.status = 400;
				return callback(error);
			}

			callback(null, circle);
		}));
	};

	var findCirclesByUser = function (user, callback) {
		var circleIds = [];

		for (var membershipKey in user.memberships) {
			var membership = user.memberships[membershipKey];
			if (membership.circle) {
				circleIds.push(membership.circle);	
			}
		}

		couch.fetch(circleIds, callback);
	};


	var updateCircle = function (circle, callback) {
		var copyCircle = function (source, dest) {
			dest.name = source.name;
			dest.isArchived = source.isArchived;
			dest.colors = source.colors;
			dest.webhooks = source.webhooks;
			dest.access = source.access;
		};

		database.get(circle._id, guard(callback, function (circleToUpdate) {
			if (circleToUpdate.type !== "circle") {
				return callback({
					message: "Update circle: Attempt to update a non-circle."
				});
			}

			copyCircle(circle, circleToUpdate);
			database.insert(circleToUpdate, guard(callback, function (body) {
				circleToUpdate._rev = body.rev;
				return callback(null, circleToUpdate);
			}));
		}));
	};

	var count = function countCircles(callback) {
		couch.findOneByKey("circles/count", null, function (err, count) {
			count = count || 0;
			callback(err, count);
		});
	};

	return {
		add: addCircle,
		get: getCircle,
		getAll: getAllCircles,
		findByUser: findCirclesByUser,
		update: updateCircle,
		count: count
	};
};