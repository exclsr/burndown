// web-server.js
// 
var http       = require('http');
var guard      = require('circle-blvd/errors').guard;

var app = undefined;
var io  = undefined;

var httpPort  = 3000;
var httpsPort = 4000;

module.exports = function (expressApp, ioModule, settings) {
    app = expressApp;
    io = ioModule;
    var sslServer  = require('circle-blvd/https-server')(settings);

    var tryToCreateHttpsServer = function (callback) {
        sslServer.create(app, httpsPort, guard(callback, function (success) {
            console.log(success);
            if (sslServer.isRunning()) {
                io.attach(sslServer.getServer());
            }

            if (callback) {
                callback();
            }
        }));
    };

    var startServer = function () {
        var httpServer = http.createServer(app);

        httpServer.listen(httpPort, function () {
            console.log("Express http server listening on port " + httpPort);
            io.attach(httpServer);
        });

        // Run an https server if we can.
        tryToCreateHttpsServer();
    };

    var isHttpsRunning = function () {
        return sslServer && sslServer.isRunning();
    };

    var restartHttps = function (callback) {
        tryToCreateHttpsServer(callback);
    };

    var setHttpsPort = function (port) {
        httpsPort = port;
    };

    var setHttpPort = function (port) {
        httpPort = port;
    };

    return {
        https: {
            restart: restartHttps,
            isRunning: isHttpsRunning,
            setPort: setHttpsPort
        },
        setPort: setHttpPort,
        start: startServer
    };
};